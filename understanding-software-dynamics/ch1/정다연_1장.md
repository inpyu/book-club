# CH1

# 데이터 센터의 측면

용어 정리

- 트랜잭션, 쿼리, 요청 → 컴퓨터 시스템ㅇ레 입력하는 메시지로, 작업을 하나의 단위로 묶어서 처리
- 서버 → 트랜잭션을 처리하는 컴퓨터
- 지연시간, 트랜잭션 응답시간 → 메시지를 보낸 후 수신될 때까지 걸린 시간
    - 지연시간은 일정 X, 초당 수천개가 넘는 확률 분포의 형태로 나타난다.
- 처리 부하 → 초당 처리할 수 있는 트랜잭션의 수
    - 초당 처리할 수 있는 트랜잭션의 수를 넘어서면 응답시간은 느려진다.
    - 꼬리 지연시간 → 가장 느린 트랜잭션
- 역동성(dynamics) → 시간에 따른 활동
    - 특정 코드가 언제 실행되는지, 무엇을 기다리는지, 어떤 메모리를 사용하는지와 관련됨.

데이터 센터에서의 성능 개선 → 서버가 처리할 수 있는 초당 트랜잭션의 수에 따라 결정됨. 느린 트랜잭션을 찾는다면 비용 없이도 같은 장비로  꼬리 지연 시간 목표도 달성하고 ,큰 부하를 처리하는 것이 가능하다.

배치 소프트웨어 → 평균 CPU 사용률 98%만 되는 것이 좋을 수 있지만, 트랜잭션 소프트웨어는 50%만 되어도 높다고 보는 편이다. 부하가 급증하면 평균 부하가 3배를 넘을 수 있기 때문이다.

책의 목표

근본적으로 프로그램은 잘 동작하고, 평균적으로 빠름을 가정. 

느린 트랜잭션 → 시간 제약이 없는 오프라인 테스트 환경에서 발견되어 수정되고, 간헐적으로 느린 트랜잭션만 발생함을 가정.

# 데이터 센터 하드웨어

- 각 서버 → 여러 프로그램 실행, 각 프로그램은 여러 스레드로 동작
    - 이메일  서버 프로그램 → 수천명의 이메일을 동시에 요청하며, 작업 스레드 100개가 입력들 받거나 읽기를 실행하며 활성 스레드가 디스트에 접근하고 있다.
        - 작업 스레드 → 요청을 받고, 요청받은 작업을 수행해 응답한 후 다른 사용자가 대기중인 요청을 계속해 나간다.
- 실제 세상 → 사용자 부하가 치솟을 때에 대비하여, 사용자와 대면하는 트랜잭션을 처리할 수 있도록 여유분의 하드웨어 자원을 갖는 것이 중요하다.
    - 서버에는 시스템 관리용 프로그램을 실행해 서버 사용량과 오류 수, 디스크 공간의 여유분을 추적해야 한다.

⇒ 각 장비 상태, 재부팅, 재설정, 다양한 소프트웨어의 시작/정지/재시작을 담당한다.

# 데이터 센터 소프트웨어

병렬로 동작하는 여러 서비스가 계층을 이뤄 개별적인 요청을 처리하고, 하나의 서비스가 여러 인스턴스로 동작해 각자의 서비스가 다른 지연시간 목표에 맞춰 응답하도록 하는 것이다.

- 데이터와 연산 결과를 보유하는 소프트웨어 캐시 운영
    - 캐싱된 데이터를 찾아 재사용 → 캐시 히트
    - 캐싱된 데이터를 찾지 못함 → 캐시 미스
    
    ⇒ 캐시의 역동성이 트랜잭션 지연시간에 영향을 준다.
    

예시 : 이메일 요청

1. 주요 메일 저장소가 있는 데이터 센터 라우팅 → 수백개의 메일 프론트엔드 서버 중 사용량이 적은 서버로 요청을 전달하는 로드밸런싱 과정을 거친다.
2. 프론트엔드 계층 → 요청 처리, HTML이나 API의 결과를 만들어 냄
3. 백엔드 계층 → 메일 내용 요청, 데이터베이스 계층과 데이터베이스 캐싱 호출
4. 소프트웨어 캐시에서 캐시 미스 발생 → 보조 메일 저장소에 접근해 디스크에서 메일 내용을 가져오는 구조

⇒ 네트워크 메시지의 전달, 원격 프로시저 호출(RPC)은 모든 활동을 하나로 묶어 처리한다. 이러한 RPC가 병렬로 끝나면 가장 느린 시간이 전체 응답시간을 결정하고, 긴 응답시간을 이해하고 조정하는 것이 중요하다.

# 긴 꼬리 지연 시간

- 지연시간 → 두 이벤트 시간으 ㅣ실제 시간 차이
    - 두 이벤트를 구체화
    - ex) RPC 지연시간 → 유저 모드 프로그램(클라이언트-서버에서는 클라이언트에 해당)에서 요청과 응답 시간 차이를 말한다. 혹은 요청 수신부터 응답을 보낼때까지 시간 차이가 될 수 도 있다.
- 서비스 RPC 요청 → 비슷한 요청은 유사한 시간이 걸리고, X축은 지연시간, Y축은 RPC 개수가 된다.
- 백분위수의 사용 → 측정값에서 빠른 1%가 아닌, 가장 느린 1%를 본다. 가장 빠른 99%와 가장 느린 1% 값의 경계는 99분위 백분위 값이 되며, 측정값의 99%는 해당 값의 이하가 된다.

# 트랜잭션이 느린 이유

- 트랜잭션은 일반적으로 빠르다 → 느려질때에는 알 수 없는 지연시간이 있고, 원인을 밝히면 코드 변경으로 긴 꼬리 지연을 줄일 수 있다.
- 여러 계층의 소프트웨어에서의 일반적인 지연 → 낮은 계층에서의 응답을 기다리며 발생
    - 계층의 이유 혹은 너무 많은 부하로 인한 발생
    
    ⇒ 응답 시간의 목표 설정 시 처리 부하의 목표도 동시에 설정하거나, 정확한 제약조건을 설정해야 한다. 즉, 각 계층이 얼마나 오래는지 보고 측정 값으로 병목 현상의 위치를 신속하게 파악해야 한다.
    

# 5가지의 기본적인 자원들

서로 관련 없는 프로그램 사이에서 공유되는 컴퓨터 하드웨어 자원 4가지는 다음과 같다 

- CPU
- 메모리
- 디스크 / SSD
- 네트워크
- 소프트웨어 임계 구역 ( 복수개의 스레드가 있을 때 5번째 기본자원 추가)
    - 두개 이상의 스레드가 동시 수행 시 옳지 않은 방식으로 공유된 데이터에 접근하는 코드의 부분.